kind: pipeline
name: python37-buster

steps:
- name: build
  image: debian:buster-slim
  commands:
  - apt update -qq -y
  - apt install -qq -y build-essential fakeroot git python-all python3-cryptography python3-stdeb python3-wheel
  - git fetch --tags
  - python3 setup.py sdist bdist_wheel
  - sed "s/=determine_version()/='$(python3 setup.py --version)'/gi" -i setup.py
  - sed "s@('readme'@('share/doc/python3-acertmgr'@" -i setup.py
  - python3 setup.py --command-packages=stdeb.command bdist_deb
  - python3 setup.py --version > version.github
- name: pypi_publish
  image: plugins/pypi
  settings:
    username: __token__
    password:
      from_secret: pypi_token
    skip_build: True
  when:
    event: tag
- name: github_publish
  image: plugins/github-release
  settings:
    api_key:
      from_secret: github_token
    draft: true
    files: deb_dist/*.deb
    title: version.github
  when:
    event: tag
